#!/usr/bin/env ruby

require 'thor'
require_relative '../movielog/movielog'

#
# App namespace
#
module Movielog
  #
  # Responsible for the console interface.
  #
  module Console
    #
    # Responsible for handling the new sub-command.
    #
    class New < Thor
      desc 'viewing', 'create a new viewing entry'
      def viewing
        Console::CreateViewing.call
      end

      desc 'review', 'create a new review entry'
      def review
        Console::CreateReview.call
      end

      desc 'feature', 'create a new feature entry'
      def feature
        Console::CreateFeature.call
      end

      desc 'review_tweet', 'tweet a review'
      def review_tweet
        Console::CreateReviewTweet.call
      end
    end

    #
    # Responsible for handling the update sub-command.
    #
    class Update < Thor
      desc 'viewings', 'update the viewing entries'
      def viewings
        Console::UpdateViewings.call
      end

      desc 'reviews', 'update the review entries'
      def reviews
        Console::UpdateReviews.call
      end

      desc 'fix_files', 'fix viewings'
      def fix_files
        Dir['viewings/*.yml'].each_with_object({}) do |file, viewings|
          viewing = YAML.load(IO.read(file))
          viewing = {
            number: viewing[:number],
            title: viewing[:display_title],
            db_title: viewing[:title],
            date: viewing[:date],
            venue: viewing[:venue]
          }

          File.open(file, 'w') { |file| file.write(viewing.to_yaml) }
        end
      end
    end

    #
    # Responsible for processing the movielog command.
    #
    class App < Thor
      desc 'new <type>', 'create a new <type> entry'
      subcommand 'new', New

      desc 'update <type>', 'update <type> entries'
      subcommand 'update', Update
    end

    App.start(ARGV)
  end
end
